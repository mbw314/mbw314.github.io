<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Particles</title>
  <link rel="stylesheet" type="text/css" href="./css/styles.css" />
  <link rel="shortcut icon" href="favicon.ico" />
  <script language="JavaScript" type="text/javascript" src="./js/jscript.js"></script>
  <link type="text/css" rel="StyleSheet" href="./css/winclassic.css" />
  <script type="text/javascript" src="./js/range.js"></script>
  <script type="text/javascript" src="./js/timer.js"></script>
  <script type="text/javascript" src="./js/slider.js"></script>
  <script type="text/javascript" src="./js/canvasUtil.js"></script>
</head>

 <body onload="init();">

<div class="container">

<div class="topsmall">

<div class="topleftsmall">
   <a href="./index.html">
  <script type="text/javascript">
          showImage("300x50");
     </script>
   </a>
</div>

<h1><a href="./index.html">Michael Bradford Williams</a></h1>
</div>

<div class="middle">

<h2>Particles in a gravitational field</h2>

<p>Here's a simple simulation of particles (the colorful circles) in a (classical) gravitational field generated by randomly placed attractors (the black circles).  The controls should be self-explanatory.</p>

<p>You'll need a modern browser to view the app. It has been tested in <a
href="http://www.mozilla.com/firefox/">Firefox</a> (Windows/Linux) and <a
href="http://www.google.com/chrome">Chrome</a> (Windows).</p> </div>

<div class="middle">
  <table border="0" align="center">
    <tr>
      <td align="right"><p>Number of Particles:</p></td>
      <td><div class="slider" id="partSlider" tabIndex="1">
        <input class="slider-input" id="partSliderInput"/></div></td>
      <td><input id="part-view" size="2" /></td>
      <td></td>
      <td><input type="button" name="refresh-part" value="Refresh Particles" onClick="refreshParticles();" /></td>
    </tr>

    <tr>
      <td align="right"><p>Number of Attractors:</p></td>
      <td><div class="slider" id="attSlider" tabIndex="1">
        <input class="slider-input" id="attSliderInput"/></div></td>
      <td><input id="att-view" size="2" /></td>
      <td></td>
      <td><input type="button" name="refresh-att" value="Refresh Attractors" onClick="refreshAttractors();" /></td>
    </tr>

    <tr>
      <td align="right"><p>Gravity Strength:</p></td>
      <td><div class="slider" id="gSlider" tabIndex="1">
        <input class="slider-input" id="gSliderInput"/></div></td>
      <td><input id="g-view" size="2" /></td>
      <td></td>
      <td><input type="button" name="pause" value="Pause Animation" onClick="pauseDrawing();">
    </tr>

    <tr>
      <td align="right"><p>Confine Particles to Canvas:</p></td>
      <td><select id="confine">
          <option value="0" selected>Yes</option>
          <option value="1">No</option>
        </select></td>
    </tr>

    <tr>
      <td align="right"><p>Particles contribute to gravity:</p></td>
      <td><select id="massive">
          <option value="0" selected>Yes</option>
          <option value="1">No</option>
        </select></td>
    </tr>
  </table>
<script type="text/javascript">

var canvas;
var ctx;
var WIDTH = 750;
var HEIGHT = 750;
var canvasUtil;
var ensemble;
var paused = false;

const ATTRACTOR_COLOR = "black";

var SPEED_MAX = 20;
var ACC_MAX = 1;
var PARTICLE_MASS_MAX = 5;

var NUM_PARTICLES_MIN = 1;
var NUM_PARTICLES = 2;
var NUM_PARTICLES_MAX = 10;

var NUM_ATTRACTORS_MIN = 1;
var NUM_ATTRACTORS = 2;
var NUM_ATTRACTORS_MAX = 5;

var TAIL = 10;

var ATT_MASS_MIN = 100;
var ATT_MASS_MOD = 300;

var G_POW_MIN = 1;
var G_POW = 5;
var G_POW_MAX = 10;

var partSl = new Slider(document.getElementById("partSlider"), document.getElementById("partSliderInput"));
var attSl  = new Slider(document.getElementById("attSlider"),  document.getElementById("attSliderInput"));
var gSl    = new Slider(document.getElementById("gSlider"),    document.getElementById("gSliderInput"));

partSl.setMinimum(NUM_PARTICLES_MIN);
partSl.setValue(NUM_PARTICLES);
partSl.setMaximum(NUM_PARTICLES_MAX);
document.getElementById("part-view").value = NUM_PARTICLES;

attSl.setMinimum(NUM_ATTRACTORS_MIN);
attSl.setValue(NUM_ATTRACTORS);
attSl.setMaximum(NUM_ATTRACTORS_MAX);
document.getElementById("att-view").value = NUM_ATTRACTORS;

gSl.setMinimum(G_POW_MIN);
gSl.setValue(G_POW);
gSl.setMaximum(G_POW_MAX);
document.getElementById("g-view").value = G_POW;


function pauseDrawing() {
  paused = !paused;
}

function refreshParticles() {
  ensemble.particles = Particle.makeRandom(NUM_PARTICLES_MAX);
}

function refreshAttractors() {
  ensemble.attractors = Attractor.makeRandom(NUM_ATTRACTORS_MAX);
}

class Attractor {
  constructor(pos, mass, color) {
    this.pos = pos;
    this.mass = mass;
    this.color = color;
  }

  toString() {
    return `attractor: pos = ${this.pos.toString()}; mass = ${this.mass.toFixed(3)}`;
  }

  draw() {
    canvasUtil.drawDisk(this.pos.x, this.pos.y, Math.sqrt(this.mass), this.color);
  }

  static makeRandom(n) {
    let attractors = [];
    for (let i=0; i<n; i++) {
      let x = Math.random() * (WIDTH * 0.5) + WIDTH * 0.25;
      let y = Math.random() * (HEIGHT * 0.5) + HEIGHT * 0.25;
      let pos = new Vec2D(x, y);
      let mass = Math.random() * (ATT_MASS_MOD + 1) + ATT_MASS_MIN;
      attractors.push(new Attractor(pos, mass, ATTRACTOR_COLOR));
    }
    return attractors;
  }
}

class Particle {
  constructor(pos, vel, acc, mass, color, tail_len) {
    // position is an array holding (at most) the previous TAIL_MAX positions
    // the most recent position is first in the array
    this.ps = new Array(TAIL).fill(pos);
    this.vel = vel;
    this.acc = acc;
    this.mass = mass;
    this.color = color;
    this.tail_len = tail_len;
  }

  toString() {
    let p = `pos = ${this.ps[0].toString()}`;
    let v = `vel = ${this.vel.toString()}`;
    let a = `acc = ${this.acc.toString()}`;
    let m = `mass = ${this.mass.toFixed(3)}`;
    return "particle: " + [p, v, a, m].join('; ');
  }

  draw() {
    // to create a tail effect, draw history of positions with older => smaller
    // this doesn't fit too easily into the CanvasUtil framework :/
    ctx.beginPath();
    ctx.fillStyle = this.color;
    for (let j=0; j<this.tail_len; j++) {
      let radius = 2 * this.mass * (this.tail_len - j) / this.tail_len;
      ctx.arc(this.ps[j].x, this.ps[j].y, radius, 0, 2 * Math.PI, true);
    }
    ctx.closePath();
    ctx.fill();
  }

  static makeRandom(n) {
    let particles = [];
    for (let i=0; i<n; i++) {
      let pos = new Vec2D(Math.random() * (WIDTH + 1), Math.random() * (HEIGHT + 1));
      // random velocity vector: random angle and speed
      let theta = Math.random() * 2 * Math.PI;
      let speed = Math.random() * SPEED_MAX / 10;
      let vel = new Vec2D(speed * Math.cos(theta), speed * Math.sin(theta))
      // no initial acceleration
      let acc = new Vec2D(0.0, 0.0);
      // random mass and color
      let mass = Math.random() * PARTICLE_MASS_MAX + 1;
      let color = Color.random();
      particles.push(new Particle(pos, vel, acc, mass, color, TAIL));
    }
    return particles;
  }
}


class Ensemble {
  constructor(particles, attractors) {
    this.particles = particles; // array of Particle objects
    this.attractors = attractors; // array of Attractor objects
  }

  toString(active) {
    let s = `Ensemble has ${this.particles.length} particles and ${this.attractors.length} attractors`;
    if (active) {
      s = `Ensemble has ${this.particles.slice(0, NUM_PARTICLES).length} particles and ${this.attractors.slice(0, NUM_ATTRACTORS).length} attractors`;
      for (let i in this.particles.slice(0, NUM_PARTICLES)) {
        s += "\n  " + this.particles[i].toString();
      }
      for (let i in this.Attractor.slice(0, NUM_ATTRACTORS)) {
        s += "\n  " + this.attractors[i].toString()
      }
    }
    return s;
  }

  static makeRandom(num_particles, num_attractors) {
    let particles = Particle.makeRandom(num_particles);
    let attractors = Attractor.makeRandom(num_attractors);
    //canvasUtil.println(`created new ensemble with ${particles.length} particles and ${attractors.length} attractors`);
    return new Ensemble(particles, attractors);
  }

  drawAttractors() {
    this.attractors.slice(0, NUM_ATTRACTORS).forEach(a => a.draw());
  }

  drawParticles() {
    this.particles.slice(0, NUM_PARTICLES).forEach(p => p.draw());
  }

  updateState() {
    // update each position, velocity, acceleration
    for (let i=0; i<NUM_PARTICLES; i++) {
      let G = Math.pow(10, G_POW / 5);
      this.particles[i].acc = new Vec2D(0.0, 0.0);

      // update acceleration using forces from the attractors and (optionally) other particles
      for (let j=0; j<NUM_ATTRACTORS; j++) {
        let r = this.particles[i].ps[0].minus(this.attractors[j].pos);
        this.particles[i].acc = r.scale(-1.0 * G * this.attractors[j].mass / Math.pow(r.normSq(), 1.5)).plus(this.particles[i].acc);
      }

      if (document.getElementById("massive").value == 0) {
        for (var j=0; j<NUM_PARTICLES; j++) {
          if (j != i) {
            let r = this.particles[i].ps[0].minus(this.particles[j].ps[0]);
            this.particles[i].acc = r.scale(-1.0 * G * this.particles[j].mass / Math.pow(r.normSq(), 1.5)).plus(this.particles[i].acc);
          }
        }
      }

      // bound acceleration
      let accNorm = this.particles[i].acc.norm();
      if (accNorm > ACC_MAX) {
        this.particles[i].acc = this.particles[i].acc.scale(ACC_MAX / accNorm);
      }

      // update and bound velocity
      this.particles[i].vel = this.particles[i].vel.plus(this.particles[i].acc);
      let speed = this.particles[i].vel.norm();
      if (speed > SPEED_MAX) {
        this.particles[i].vel = this.particles[i].vel.scale(SPEED_MAX / speed);
      }

      // if keeping the particles inside the canvas...
      if (document.getElementById("confine").value == 0) {
        if (this.particles[i].ps[0].x + this.particles[i].vel.x > WIDTH || this.particles[i].ps[0].x + this.particles[i].vel.x < 0) {
          this.particles[i].vel.x *= -1.0;
        }
        if (this.particles[i].ps[0].y + this.particles[i].vel.y > HEIGHT || this.particles[i].ps[0].y + this.particles[i].vel.y < 0) {
          this.particles[i].vel.y *= -1.0;;
        }
      }

      // get new position, update previous positions
      let pos = this.particles[i].ps[0].plus(this.particles[i].vel)
      this.particles[i].ps = [pos].concat(this.particles[i].ps.slice(0, TAIL - 1));
    }
  }
}

function draw() {
  if (paused) {
    return 0;
  }

  canvasUtil.clearCanvas("white");
  ensemble.updateState();
  ensemble.drawAttractors();
  ensemble.drawParticles();
}


function init(){
  canvas = document.getElementById("canvas");
  canvas.width = WIDTH;
  canvas.height = HEIGHT;
  if (canvas.getContext){
    ctx = canvas.getContext('2d');
    canvasUtil = new CanvasUtil(ctx, WIDTH, HEIGHT, document.outform.output);
    ensemble = Ensemble.makeRandom(NUM_PARTICLES_MAX, NUM_ATTRACTORS_MAX);
    return setInterval(draw, 5);
  }
  else {
    alert('You need a better web browser to see this.');
  }
}

partSl.onchange = function () {
  document.getElementById("part-view").value = partSl.getValue();
  NUM_PARTICLES = parseInt(partSl.getValue());
    canvasUtil.println(`new number of particles = ${NUM_PARTICLES}`);
};

attSl.onchange = function () {
  document.getElementById("att-view").value = attSl.getValue();
  NUM_ATTRACTORS = parseInt(attSl.getValue());
  canvasUtil.println(`new number of attractors = ${NUM_ATTRACTORS}`);
};

gSl.onchange = function () {
  document.getElementById("g-view").value = gSl.getValue();
  G_POW = parseInt(gSl.getValue());
  canvasUtil.println(`new Gravity exponent = ${G_POW}`);
};

window.onresize = function () {
  partSl.recalculate();
  attSl.recalculate();
  gSl.recalculate();
  init();
};
</script>

</div>

<div class="middle">
    <canvas id="canvas" width="750" height="750">
        <p>Your browser is currently unsupported.</p>
        <p>Supported browsers: <a href="http://www.opera.com">Opera</a>, <a
          href="http://www.mozilla.com">Firefox</a>, <a
          href="http://www.apple.com/safari">Safari</a>, and <a
          href="http://www.konqueror.org">Konqueror</a>.</p>
    </canvas>
</div>

<div class="middle">
<table align="center">
  <tr>
    <td><form name="outform">
        <textarea rows="25" cols="80" name="output"></textarea>
        </form>
    </td>
  </tr>
</table>
</div>

<div class="bottom">
<p>last modified: 12/31/2019</p>
</div>

</div>

</body>
</html>
